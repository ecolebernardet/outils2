<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Observations - Style Compteur</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        :root { --primary: #ff637e; --bg-dark: #000000; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-dark); margin: 0; padding: 10px; min-height: 100vh; color: white; }
        
        .columns-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; max-width: 500px; margin: 0 auto; }
        
        /* STYLE CADRE BLANC (COMME COMPTEUR) */
        .student-item { 
            background-color: #ffffff; /* Fond blanc */
            padding: 6px 10px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            cursor: pointer; 
            border-radius: 50px; 
            margin-bottom: 4px; 
            transition: all 0.1s;
        }

        /* COULEURS DE POLICE PAR GENRE (COMME COMPTEUR) */
        .text-girl { color: #db2777; border-color: #fbcfe8; } 
        .text-boy { color: #2563eb; border-color: #bfdbfe; } 
        
        .is-absent { opacity: 0.25 !important; filter: grayscale(1); text-decoration: line-through; }
        
        .student-name { font-weight: 800; font-size: 0.7rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .status-icon { font-size: 0.7rem; opacity: 0.8; }

        /* MODAL */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(4px); }
        .modal-content { background: #1a1a1a; padding: 20px; border-radius: 20px; width: 92%; max-width: 400px; border: 1px solid #333; }
        textarea { width: 100%; margin: 10px 0; padding: 12px; border-radius: 12px; border: 1px solid #333; font-size: 0.8rem; background: #000; color: #fff; outline: none; }
        .btns { display: flex; gap: 10px; }
        .modal-btn { flex: 1; padding: 14px; border: none; border-radius: 50px; font-weight: 900; cursor: pointer; text-transform: uppercase; font-size: 10px; }
        .btn-save { background: var(--primary); color: white; }
        .btn-cancel { background: #333; color: #ccc; }

        /* NAV BAS */
        .bottom-nav { width: 100%; max-width: 500px; margin: 25px auto 0; padding-bottom: 40px; }
        .nav-btn { font-weight: 900; border-radius: 50px; font-size: 10px; padding: 12px; border: none; flex: 1; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .no-select { -webkit-tap-highlight-color: transparent; user-select: none; }
    </style>
</head>
<body>

    <div id="listeContainer" class="columns-container"></div>

    <footer class="bottom-nav flex gap-2">
        <button onclick="exportToFile()" class="nav-btn bg-zinc-800 text-white">ðŸ‘†exporter .txtðŸ‘†</button>
        <label class="nav-btn bg-zinc-800 text-white cursor-pointer">
            ðŸ‘‡importer .txtðŸ‘‡
            <input type="file" id="importFile" class="hidden" accept=".txt">
        </label>
        <button onclick="window.location.href='index.html'" class="nav-btn bg-[#71bd7b] text-green-950">Accueil</button>
    </footer>

    <div id="modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="modalTitle" style="margin:0; font-size: 1.1rem; font-weight: 800; color: white;">Ã‰lÃ¨ve</h2>
            <textarea id="commentInput" rows="8" placeholder="Ã‰crire une observation..."></textarea>
            <div class="btns">
                <button class="modal-btn btn-cancel" onclick="closeAllModals()">Fermer</button>
                <button class="modal-btn btn-save" onclick="saveData()">Enregistrer</button>
            </div>
        </div>
    </div>

    <script>
        let elevesInscrits = JSON.parse(localStorage.getItem('maListeEleves')) || [];
        let savedComments = JSON.parse(localStorage.getItem('studentObservations')) || {};
        let absentsList = JSON.parse(localStorage.getItem('absentsList')) || [];
        let currentStudentId = "";

        function formatName(str) {
            if(!str) return "";
            const parts = str.trim().split(' ');
            const first = parts[0].charAt(0).toUpperCase() + parts[0].slice(1).toLowerCase();
            const last = parts.slice(1).join(' ').toUpperCase();
            return (first + ' ' + last).trim();
        }

        function renderList() {
            const container = document.getElementById('listeContainer');
            container.innerHTML = "";
            
            if (elevesInscrits.length === 0) {
                container.innerHTML = `<div class="col-span-2 text-center p-10 text-zinc-500 text-[10px] font-bold uppercase">Aucune donnÃ©e.</div>`;
                return;
            }

            const groupes = { "CE2": [], "CM2": [] };
            elevesInscrits.forEach(el => {
                const niv = el.niveau.toUpperCase().includes('CE2') ? "CE2" : "CM2";
                groupes[niv].push(el);
            });

            ["CE2", "CM2"].forEach(niv => {
                const col = document.createElement('div');
                col.className = "flex flex-col";
                
                // TITRES COLORÃ‰S (JAUNE POUR CE2, VERT POUR CM2)
                const colorTitle = (niv === 'CE2') ? 'text-yellow-400' : 'text-green-500';
                col.innerHTML = `<h2 class="${colorTitle} text-[12px] font-black uppercase tracking-[0.2em] text-center mb-3">${niv}</h2>`;
                
                const listWrapper = document.createElement('div');
                
                groupes[niv].sort((a,b) => a.identite.localeCompare(b.identite)).forEach(el => {
                    const isAbs = absentsList.includes(el.id);
                    const genderClass = (el.sexe.toLowerCase() === 'f') ? 'text-girl' : 'text-boy';
                    
                    const item = document.createElement('div');
                    item.className = `student-item no-select ${genderClass} ${isAbs ? 'is-absent' : ''}`;
                    
                    const hasNote = (savedComments[el.id] || "").trim().length > 0;
                    
                    item.innerHTML = `
                        <span class="student-name">${formatName(el.identite)}</span>
                        <span class="status-icon">${hasNote ? 'ðŸ”Ž' : 'ï¼‹'}</span>
                    `;
                    
                    item.onclick = () => openCommentModal(el.id, formatName(el.identite));
                    listWrapper.appendChild(item);
                });
                
                col.appendChild(listWrapper); 
                container.appendChild(col);
            });
        }

        function openCommentModal(id, nom) {
            currentStudentId = id;
            document.getElementById('modalTitle').innerText = nom;
            document.getElementById('commentInput').value = savedComments[id] || "";
            document.getElementById('modal').style.display = 'flex';
            setTimeout(() => document.getElementById('commentInput').focus(), 100);
        }

        function closeAllModals() { document.getElementById('modal').style.display = 'none'; }

        function saveData() {
            const val = document.getElementById('commentInput').value;
            if(val.trim() === "") delete savedComments[currentStudentId];
            else savedComments[currentStudentId] = val;
            localStorage.setItem('studentObservations', JSON.stringify(savedComments));
            renderList(); closeAllModals();
        }

        function exportToFile() {
            let cleanedComments = {};
            elevesInscrits.forEach(s => { if(savedComments[s.id]) cleanedComments[s.id] = savedComments[s.id]; });
            const bundle = {
                eleves: elevesInscrits,
                observations: cleanedComments,
                absents: absentsList,
                date: new Date().toLocaleDateString()
            };
            const blob = new Blob([JSON.stringify(bundle, null, 2)], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `observations_${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        document.getElementById('importFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.eleves && confirm("Ã‰craser les donnÃ©es actuelles par celles du fichier ?")) {
                        localStorage.setItem('maListeEleves', JSON.stringify(data.eleves));
                        localStorage.setItem('studentObservations', JSON.stringify(data.observations || {}));
                        localStorage.setItem('absentsList', JSON.stringify(data.absents || []));
                        window.location.reload();
                    }
                } catch (err) { alert("Fichier invalide."); }
            };
            reader.readAsText(file);
        });

        window.onload = renderList;
    </script>
</body>
</html>