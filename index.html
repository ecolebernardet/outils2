<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Le Bureau du Prof</title>

    <style>
        /* --- CHARTE GRAPHIQUE --- */
        :root {
            --bg-color: #eef2f5;
            --widget-bg: #ffffff;
            --primary-color: #4a90e2;
            --text-color: #333;
            --shadow: 0 8px 24px rgba(149, 157, 165, 0.2);
            --border-radius: 18px;
        }

        body, html {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            background-color: var(--bg-color);
            font-family: 'Segoe UI', system-ui, sans-serif;
            overflow: hidden;
        }

        #board { width: 100vw; height: 100vh; position: relative; z-index: 0; transition: background 0.3s ease; }

        /* --- WIDGETS --- */
        .widget {
            position: absolute;
            background: var(--widget-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            min-width: 320px;
            display: flex;
            flex-direction: column;
            z-index: 1;
            border: 2px solid transparent;
            height: auto;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .widget:focus-within { border-color: var(--primary-color); box-shadow: 0 12px 30px rgba(74, 144, 226, 0.3); }
        .widget[data-type="homework"]:focus-within { border-color: #ff4757; }
        .widget[data-type="iframe"]:focus-within { border-color: #2bcbba; }

        .widget[data-type="date"], .widget[data-type="time"] { min-width: unset; width: auto; }

        .widget[data-type="date"] .editor-container,
        .widget[data-type="time"] .editor-container {
            resize: none;
            overflow: hidden;
            container-type: inline-size;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: white;
        }

        .widget[data-type="date"]:hover .editor-container,
        .widget[data-type="time"]:hover .editor-container {
            resize: both;
        }

        .widget[data-type="date"] .editor-container { min-width: 150px; min-height: 180px; width: 220px; height: 260px; }
        .widget[data-type="time"] .editor-container { min-width: 120px; min-height: 80px; width: 200px; height: 100px; }

        .widget .widget-header, .widget .editor-toolbar { display: none; }
        .widget:focus-within .widget-header, .widget:focus-within .editor-toolbar { display: flex; }

        .widget-header {
            padding: 10px 15px;
            cursor: move;
            justify-content: space-between;
            align-items: center;
            background: #fcfcfc;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            border-bottom: 1px solid #eee;
        }

        .widget-title { font-weight: 700; color: var(--primary-color); font-size: 0.85em; text-transform: uppercase; }
        .close-btn { cursor: pointer; font-size: 20px; color: #ccc; padding: 0 5px; }
        .close-btn:hover { color: #ff5f56; }

        .widget-content { padding: 10px; flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }

        .editor-container { 
            display: flex; flex-direction: column; border: 1px solid #eee; border-radius: 8px; background: white; 
            flex-grow: 1; overflow: hidden; resize: none; min-width: 280px; min-height: 120px;
        }

        .widget:hover .editor-container { resize: both; }
        
        /* Cacher la poign√©e de redimensionnement par d√©faut */
        .editor-container::-webkit-resizer { background-color: transparent; }
        /* L'afficher au survol */
        .widget:hover .editor-container::-webkit-resizer { 
            background-color: #ccc; 
            background-image: linear-gradient(135deg, transparent 50%, #333 50%, #333 60%, transparent 60%, transparent 70%, #333 70%, #333 80%, transparent 80%);
        }

        .editor-toolbar { gap: 4px; padding: 5px; background: #f8f9fa; border-bottom: 1px solid #eee; flex-wrap: wrap; align-items: center; }
        .editor-toolbar button, .editor-toolbar select, .editor-toolbar input { 
            padding: 2px 4px; cursor: pointer; border: 1px solid #ddd; background: white; border-radius: 4px; font-size: 11px;
            height: 26px; box-sizing: border-box;
        }
        
        @font-face { font-family: 'KGPerfectPenmanship'; src: url('./KGPerfectPenmanship.ttf') format('opentype'); font-weight: normal; font-style: normal; }
        @font-face { font-family: 'Andika'; src: url('./Andika.ttf') format('opentype'); font-weight: normal; font-style: normal; }
        @font-face { font-family: 'OpenDyslexicLocal'; src: url('./OpenDyslexic-Regular.otf') format('opentype'); font-weight: normal; font-style: normal; }
        @font-face { font-family: 'BelleAllureGS'; src: url('BelleAllureGS-Gros.otf') format('opentype'); font-weight: normal; font-style: normal; }

        .editor-content { padding: 10px; outline: none; overflow: auto; text-align: left; flex-grow: 1; }

        #toolbar-container { position: fixed; bottom: 30px; left: 30px; display: flex; flex-direction: column; align-items: flex-start; z-index: 9999; }
        #tools-menu { display: none; background: #1F1F21; border-radius: 12px; padding: 10px; box-shadow: var(--shadow); margin-bottom: 15px; flex-direction: column; gap: 8px; min-width: 180px; border: 1px solid #eee; position: relative; }
        #tools-menu.active { display: flex; }
        
        #undo-btn { position: fixed; bottom: 30px; right: 30px; background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; z-index: 9999; box-shadow: var(--shadow); }
        .tool-btn { background: var(--primary-color); color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 10px; width: 100%; white-space: nowrap; }
        .tool-btn2 { background: #dddddd; color: black; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 10px; width: 100%; white-space: nowrap; }
        #main-tool-btn { background: #333; width: 200px; justify-content: center; }

        .exit-fs-btn { display: none; position: absolute; top: 10px; right: 10px; z-index: 99999; background: rgba(0, 0, 0, 0.5);
            color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 14px; }
            
        :fullscreen .exit-fs-btn { display: block; }

        #bg-submenu {
            display: none; position: absolute; left: 105%; bottom: 0; background: white; border-radius: 12px; padding: 12px;
            box-shadow: var(--shadow); grid-template-columns: repeat(3, 1fr); gap: 10px; min-width: 240px; border: 1px solid #eee;
        }
        #bg-submenu.active { display: grid; }
        .bg-thumb { width: 70px; height: 50px; border-radius: 6px; border: 2px solid #eee; cursor: pointer; background-size: cover; background-position: center; transition: 0.2s; }
        .bg-thumb:hover { transform: scale(1.05); border-color: var(--primary-color); }
        
        .calendar-page { 
            width: 100%; height: 100%; display: flex; flex-direction: column; border: 1px solid #ced4da; 
            border-radius: 8px; overflow: hidden; background: white; text-align: center; position: relative;
            padding-top: 15px; box-sizing: border-box;
        }

        .calendar-page::before { content: "‚óè ‚óè ‚óè"; position: absolute; top: -8px; left: 0; right: 0; color: #8e9aaf; font-size: 24px; letter-spacing: 15px; text-shadow: 0 5px 0 #6c757d; }
        .calendar-header { background: #D17B6B; height: 20%; min-height: 30px; border-bottom: 2px solid #D17B6B; margin-bottom: 5px; }
        .calendar-body { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; padding: 5px; }

        .calendar-day-name { font-size: 12cqw; font-weight: 700; color: #333; text-transform: lowercase; }
        .calendar-day-number { font-size: 35cqw; font-weight: 800; color: #2c3e50; line-height: 1em; margin: 2cqw 0; }
        .calendar-month { font-size: 15cqw; font-weight: 600; color: #333; }

        .clock-time { font-size: 26cqw; font-weight: 800; color: var(--primary-color); font-family: 'Courier New', monospace; display: flex; align-items: baseline; justify-content: center; width: 100%; gap: 4px; }
        .clock-seconds { font-size: 0.5em; color: #888; margin-left: 2cqw; }

        #modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:20000; justify-content:center; align-items:center; }
        .modal-content { background:white; padding:30px; border-radius:var(--border-radius); box-shadow:var(--shadow); text-align:center; max-width:400px; width:90%; }
        .modal-content button { padding: 10px 20px; border-radius: 10px; font-weight: 600; cursor: pointer; transition: transform 0.1s; }
        .modal-content .btn-cancel { border: 1px solid #ddd; background: #f8f9fa; color: var(--text-color); }
        .modal-content .btn-confirm { border: none; background: #ff4757; color: white; }
    </style>
</head>
<body>

    <div id="board"></div>

    <div id="toolbar-container">
        <div id="tools-menu">
            <button class="tool-btn" onclick="createWidget('youtube'); toggleMenu()" style="background: #E7180B;"><span>üé¨</span> Vid√©o YouTube</button>
            <button class="tool-btn" onclick="createWidget('outilsprofs'); toggleMenu()" style="background: #FF692A;"><span>üéí</span> OutilsProfs</button>
            <button class="tool-btn" onclick="createWidget('iframe'); toggleMenu()" style="background: #FFD230;"><span>üíª</span> Fen√™tre Web</button>
            <button class="tool-btn" onclick="createWidget('time'); toggleMenu()" style="background: #7CCF35;"><span>üïí</span> Horloge</button>
            <button class="tool-btn" onclick="createWidget('date'); toggleMenu()" style="background: #3BB8DB;"><span>üìÖ</span> Agenda</button>
            <button class="tool-btn" onclick="createWidget('homework'); toggleMenu()" style="background: #2B7FFF;"><span>üìù</span> Devoirs</button>
            <button class="tool-btn" onclick="createWidget('text'); toggleMenu()" style="background: #8E51FF;"><span>üñäÔ∏è</span> Texte</button>
            
            <hr style="width: 100%; border: 0; border-top: 1px solid #eee; margin: 5px 0;">
            <button class="tool-btn" style="background: #71717B;" onclick="toggleSubMenu(event)"><span>üñºÔ∏è</span> Choisir fond ‚ùØ</button>
            
            <div id="bg-submenu">
                <div class="bg-thumb" style="background-color: #eef2f5;" onclick="applyBackground('none'); saveBg('none')" title="D√©faut"></div>
                <div class="bg-thumb" style="background-color: #2f3542;" onclick="applyBackground('#2f3542'); saveBg('#2f3542')" title="Ardoise"></div>
                <div class="bg-thumb" style="background-color: #104626;" onclick="applyBackground('#104626'); saveBg('#104626')" title="Vert Tableau"></div>
                <div class="bg-thumb" style="background-color: #BAA09B;" onclick="applyBackground('#BAA09B'); saveBg('#BAA09B')" title="Vieux rose"></div>
                <div class="bg-thumb" style="background-image: url('https://www.transparenttextures.com/patterns/grid-me.png');" onclick="applyBackground('url(https://www.transparenttextures.com/patterns/grid-me.png)'); saveBg('url(https://www.transparenttextures.com/patterns/grid-me.png)')" title="Carreaux"></div>
                <div class="bg-thumb" style="background-image: url('https://www.transparenttextures.com/patterns/lined-paper.png');" onclick="applyBackground('url(https://www.transparenttextures.com/patterns/lined-paper.png)'); saveBg('url(https://www.transparenttextures.com/patterns/lined-paper.png)')" title="Lignes"></div>
                <div class="bg-thumb" style="background-image: url('https://www.transparenttextures.com/patterns/arches.png');" onclick="applyBackground('url(https://www.transparenttextures.com/patterns/arches.png)'); saveBg('url(https://www.transparenttextures.com/patterns/arches.png)')" title="Arches"></div>
                <div class="bg-thumb" style="background-image: url('https://www.transparenttextures.com/patterns/shattered.png');" onclick="applyBackground('url(https://www.transparenttextures.com/patterns/shattered.png)'); saveBg('url(https://www.transparenttextures.com/patterns/shattered.png)')" title="√âclats"></div>
                <button class="tool-btn" onclick="document.getElementById('bg-upload').click()" style="background: #8e44ad; padding: 5px; font-size: 10px; grid-column: span 3; border-radius: 8px;"><span>üì∑</span> Importer image</button>
            </div>

            <hr style="width: 100%; border: 0; border-top: 1px solid #eee; margin: 5px 0;">
            <button class="tool-btn2" onclick="exportConfig()"><span>üíæ</span> Exporter config</button>
            <button class="tool-btn2" onclick="document.getElementById('import-input').click()"><span>üìÇ</span> Importer config</button>
            <input type="file" id="import-input" style="display:none" accept=".json" onchange="importConfig(this)">
            <button class="tool-btn2" onclick="clearBoard(); toggleMenu()" style="background: #ED8595; margin-top:5px;"><span>‚ùå</span> Effacer tout</button>
        </div>
        <button id="main-tool-btn" class="tool-btn" onclick="toggleMenu()">MENU</button>
    </div>

    <button id="undo-btn" onclick="undoAction()"><span>‚Ü©Ô∏è</span> Annuler</button>

    <div id="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-top:0; color:#ff4757;">‚ö†Ô∏è Tout effacer ?</h3>
            <p style="color:#666;">Cette action videra votre bureau. C'est irr√©versible.</p>
            <div style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
                <button class="btn-cancel" onclick="closeModal()">Annuler</button>
                <button class="btn-confirm" onclick="confirmClearBoard()">Oui, vider tout</button>
            </div>
        </div>
    </div>

    <script type="text/html" id="toolbar-html">
    <div class="editor-toolbar">
        <button onclick="format('bold')">G</button>
        <button onclick="format('italic')">I</button>
        <button onclick="format('underline')">S</button>
        <span style="font-size: 10px; margin-left: 5px;">Texte :</span>
        <input type="color" onchange="format('foreColor', this.value)" title="Couleur du texte">
        <span style="font-size: 10px; margin-left: 5px;">Surligner :</span>
        <input type="color" onchange="format('backColor', this.value)" title="Surligner" value="#ffff00">
        <span style="font-size: 10px; margin-left: 5px;">Fond :</span>
        <input type="color" onchange="changeWidgetBg(this, this.value)" title="Fond du cadre" value="#ffffff">
        <button onclick="toggleTransparency(this)" title="Fond transparent" style="margin-left: 5px;">ü´•</button>
        <select onchange="formatFontFamily(this.value)" style="width: 140px; margin-left: 5px;">
                <option value="Arial, sans-serif">Arial</option>
                <option value="'Segoe UI', sans-serif">Segoe UI</option>
                <option value="'Comic Sans MS', cursive">Comic Sans MS</option>
                <option value="Verdana, sans-serif">Verdana</option>
                <option value="'KGPerfectPenmanship', sans-serif">KGPerfectPenmanship</option>
                <option value="'Andika', sans-serif">Andika</option>
                <option value="'OpenDyslexicLocal', sans-serif">üß© OpenDyslexic</option>
                <option value="'BelleAllureGS', cursive">üìè Belle Allure GS</option>
            </select>
        <input type="number" value="40" min="8" max="100" onchange="formatFontSize(this.value)" style="width: 40px;">
    </div>
    </script>

    <template id="template-text">
        <div class="editor-container">
            <div class="editor-toolbar-placeholder"></div>
            <div class="editor-content" contenteditable="true" oninput="saveBoard()" style="font-size: 40px;"></div>
        </div>
    </template>

    <template id="template-homework">
        <div class="editor-container"><div class="editor-toolbar-placeholder"></div><div class="editor-content" contenteditable="true" oninput="saveBoard()">
            <span style="color: #D4C9C7; font-size: 20px; font-weight: bold;">‚úçüèª Devoirs √† noter </span><br>
            <p><span style="color: red; background-color: #F7E02A; font-size: 30px; font-weight: bold;">Pour</span></p>
            <p><span style="color: #f7639f; font-size: 25px; font-weight: bold;">&nbsp;&nbsp;üëâüèª CE2 =</span></p>
            <p><span style="color: #12a2e0; font-size: 25px; font-weight: bold;">&nbsp;&nbsp;üëâüèΩ CM2 =</span></p>
            <p><span style="color: #D9C93B; font-size: 25px; font-weight: bold;">&nbsp;&nbsp;üëâ TOUS =</span></p>
        </div></div>
    </template>

    <template id="template-date">
        <div class="editor-container">
            <div class="editor-toolbar" style="justify-content: center; border-bottom: none;">
                <button onclick="toggleTransparency(this)" title="Fond transparent">ü´•</button>
            </div>
            <div class="calendar-page">
                <div class="calendar-header"></div>
                <div class="calendar-body">
                    <div class="calendar-day-name"></div>
                    <div class="calendar-day-number"></div>
                    <div class="calendar-month"></div>
                </div>
            </div>
        </div>
    </template>

    <template id="template-time">
        <div class="editor-container">
            <div class="clock-time">
                <span class="clock-hm">00:00</span><span class="clock-seconds">00</span>
            </div>
        </div>
    </template>

    <template id="template-iframe">
        <div class="editor-container" style="height: 400px; width: 550px;">
            <button class="exit-fs-btn" onclick="document.exitFullscreen()">‚úñ Quitter Plein √âcran</button>
            <div class="editor-toolbar">
                <input type="text" placeholder="Collez l'URL ici..." style="flex-grow: 1;" onchange="loadIframe(this)">
                <button onclick="toggleFullScreen(this.closest('.editor-container'))" title="Plein √©cran">‚õ∂</button>
            </div>
            <iframe src="" style="flex-grow: 1; border: none; background: white;" allow="microphone; camera; display-capture; autoplay"></iframe>
        </div>
    </template>

    <template id="template-outilsprofs">
        <div class="editor-container" style="height: 500px; width: 800px;">
            <button class="exit-fs-btn" onclick="document.exitFullscreen()">‚úñ Quitter Plein √âcran</button>
            <div class="editor-toolbar" style="display: flex; justify-content: flex-end;">
                <button onclick="toggleFullScreen(this.closest('.editor-container'))" title="Plein √©cran">‚õ∂ Plein √©cran</button>
            </div>
            <iframe src="https://ecolebernardet.github.io/outilsprofs" style="flex-grow: 1; border: none; background: white;" allow="microphone; camera; display-capture; autoplay"></iframe>
        </div>
    </template>

    <template id="template-youtube">
        <div class="editor-container" style="height: 350px; width: 600px;">
            <div class="editor-toolbar">
                <input type="text" placeholder="Collez le lien YouTube ici..." style="flex-grow: 1;" onchange="loadYoutube(this)">
                <button onclick="toggleFullScreen(this.closest('.editor-container'))" title="Plein √©cran">‚õ∂</button>
                <button onclick="toggleTransparency(this)" title="Fond transparent">ü´•</button>
            </div>
            <iframe src="" style="flex-grow: 1; border: none; background: #000;" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
        </div>
    </template>

    <input type="file" id="bg-upload" style="display:none" accept="image/*" onchange="handleBgUpload(this)">

    <script>
        let widgetCount = 0;
        let historyStack = [];

        function takeSnapshot() {
            const data = localStorage.getItem('bureauProfData');
            if (data) historyStack.push(data);
            if (historyStack.length > 20) historyStack.shift();
        }

        function toggleMenu() { document.getElementById('tools-menu').classList.toggle('active'); document.getElementById('bg-submenu').classList.remove('active'); }
        function toggleSubMenu(e) { e.stopPropagation(); document.getElementById('bg-submenu').classList.toggle('active'); }
        
        document.getElementById('board').onclick = (e) => { 
            if(e.target.id === 'board') {
                document.getElementById('tools-menu').classList.remove('active');
                document.getElementById('bg-submenu').classList.remove('active');
            }
        };

        function toggleTransparency(btn) {
            takeSnapshot();
            const widget = btn.closest('.widget');
            const container = widget.querySelector('.editor-container');
            const isNowTransparent = widget.getAttribute('data-transparent') !== 'true';
            widget.setAttribute('data-transparent', isNowTransparent);

            if (!isNowTransparent) {
                widget.style.backgroundColor = 'var(--widget-bg)';
                widget.style.boxShadow = 'var(--shadow)';
                if(container) {
                    container.style.background = 'white';
                    container.style.border = '1px solid #eee';
                }
            } else {
                widget.style.backgroundColor = 'transparent';
                widget.style.boxShadow = 'none';
                if(container) {
                    container.style.background = 'transparent';
                    container.style.border = 'none';
                }
            }
            saveBoard();
        }
        
        function format(cmd, val = null) { takeSnapshot(); document.execCommand(cmd, false, val); saveBoard(); }
        function formatFontSize(px) { takeSnapshot(); document.execCommand('fontSize', false, "7"); document.querySelectorAll('font[size="7"]').forEach(f => { f.removeAttribute('size'); f.style.fontSize = px + 'px'; }); saveBoard(); }
        function formatFontFamily(f) { takeSnapshot(); document.execCommand('fontName', false, f); saveBoard(); }

        function loadIframe(input) {
            const url = input.value;
            const iframe = input.parentElement.nextElementSibling;
            iframe.src = url.startsWith('http') ? url : 'https://' + url;
            saveBoard();
        }

        function createWidget(type, autoSave = true) {
            if (autoSave) takeSnapshot();
            widgetCount++;
            const template = document.getElementById(`template-${type}`);
            const widget = document.createElement('div');
            widget.className = 'widget';
            widget.dataset.type = type;
            widget.tabIndex = 0;
            widget.style.left = (60 + (widgetCount * 20)) + 'px';
            widget.style.top = (60 + (widgetCount * 20)) + 'px';

            const titles = { 'text': 'Note', 'homework': 'Devoirs', 'date': 'Agenda', 'time': 'Horloge', 'iframe': 'Fen√™tre Web', 'outilsprofs': 'OutilsProfs', 'youtube': 'Vid√©o YouTube' };
            widget.innerHTML = `<div class="widget-header"><span class="widget-title">${titles[type]}</span><span class="close-btn" onclick="takeSnapshot(); this.closest('.widget').remove(); saveBoard();">√ó</span></div><div class="widget-content"></div>`;

            const contentClone = template.content.cloneNode(true);
            const toolbarPlaceholder = contentClone.querySelector('.editor-toolbar-placeholder');
            if (toolbarPlaceholder) toolbarPlaceholder.outerHTML = document.getElementById('toolbar-html').innerHTML;

            if (type === 'date') {
                const now = new Date();
                contentClone.querySelector('.calendar-day-name').textContent = now.toLocaleDateString('fr-FR', {weekday:'long'});
                contentClone.querySelector('.calendar-day-number').textContent = now.getDate();
                contentClone.querySelector('.calendar-month').textContent = now.toLocaleDateString('fr-FR', {month:'long'});
            } else if (type === 'time') { 
                updateClock(widget); 
                const now = new Date();
                contentClone.querySelector('.clock-hm').textContent = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');
                contentClone.querySelector('.clock-seconds').textContent = now.getSeconds().toString().padStart(2,'0');
            }

            widget.querySelector('.widget-content').appendChild(contentClone);
            makeDraggable(widget);
            document.getElementById('board').appendChild(widget);
            
            const container = widget.querySelector('.editor-container');
            if(container) new ResizeObserver(() => saveBoard()).observe(container);

            if (autoSave) saveBoard();
            return widget;
        }

        function updateClock(w) {
            setInterval(() => {
                const now = new Date();
                const hm = w.querySelector('.clock-hm'), s = w.querySelector('.clock-seconds');
                if (hm) hm.textContent = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');
                if (s) s.textContent = now.getSeconds().toString().padStart(2,'0');
            }, 1000);
        }

        function changeWidgetBg(input, color) {
            takeSnapshot();
            const widget = input.closest('.widget');
            const container = widget.querySelector('.editor-container');
            const content = widget.querySelector('.editor-content');
            widget.setAttribute('data-transparent', 'false');
            widget.style.boxShadow = 'var(--shadow)';
            widget.style.backgroundColor = color;
            if(container) { container.style.background = color; container.style.border = '1px solid #eee'; }
            if(content) content.style.background = color;
            saveBoard();
        }

        function makeDraggable(elmnt) {
            const header = elmnt.querySelector('.widget-header');
            header.onmousedown = (e) => {
                if (e.target.className === 'close-btn' || e.target.tagName === 'INPUT' || e.target.closest('.editor-toolbar')) return;
                document.querySelectorAll('.widget').forEach(w => w.style.zIndex = "1");
                elmnt.style.zIndex = "1000";
                let pos3 = e.clientX, pos4 = e.clientY;
                document.onmousemove = (e) => {
                    elmnt.style.top = (elmnt.offsetTop - (pos4 - e.clientY)) + "px";
                    elmnt.style.left = (elmnt.offsetLeft - (pos3 - e.clientX)) + "px";
                    pos3 = e.clientX; pos4 = e.clientY;
                };
                document.onmouseup = () => { document.onmousemove = null; saveBoard(); };
            };
        }

        function loadYoutube(input) {
            let url = input.value;
            let videoId = '';
            if (url.includes('youtube.com/watch?v=')) {
                videoId = url.split('v=')[1].split('&')[0];
            } else if (url.includes('youtu.be/')) {
                videoId = url.split('youtu.be/')[1].split('?')[0];
            } else if (url.includes('youtube.com/embed/')) {
                videoId = url.split('embed/')[1].split('?')[0];
            }
            const iframe = input.parentElement.nextElementSibling;
            if (videoId) { iframe.src = `https://www.youtube.com/embed/${videoId}`; saveBoard(); }
        }

        function applyBackground(bg) {
            const board = document.getElementById('board');
            board.style.backgroundImage = bg.startsWith('url') ? bg : 'none';
            board.style.backgroundColor = bg.startsWith('#') ? bg : (bg === 'none' ? 'var(--bg-color)' : 'transparent');
            const isPattern = bg.includes('grid-me') || bg.includes('lined-paper') || bg.includes('graphy') || bg.includes('arches') || bg.includes('shattered');
            board.style.backgroundSize = isPattern ? 'auto' : 'cover';
        }

        function saveBg(bg) { localStorage.setItem('bureauProfBg', bg); }

        function handleBgUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => { applyBackground(`url("${e.target.result}")`); saveBg(`url("${e.target.result}")`); };
                reader.readAsDataURL(input.files[0]);
            }
        }
        function undoAction() {
            if (historyStack.length > 0) {
                const lastState = JSON.parse(historyStack.pop());
                document.querySelectorAll('.widget').forEach(w => w.remove());
                lastState.forEach(wData => restoreWidget(wData));
                saveBoard();
            }
        }
        function exportConfig() {
            const data = { bg: localStorage.getItem('bureauProfBg'), widgets: JSON.parse(localStorage.getItem('bureauProfData') || "[]") };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = `bureau-prof-${new Date().toLocaleDateString()}.json`;
            a.click();
        }
        function importConfig(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = JSON.parse(e.target.result);
                    if (data.bg) localStorage.setItem('bureauProfBg', data.bg);
                    if (data.widgets) localStorage.setItem('bureauProfData', JSON.stringify(data.widgets));
                    window.location.reload();
                };
                reader.readAsText(input.files[0]);
            }
        }
        function saveBoard() {
            const widgets = [];
            document.querySelectorAll('.widget').forEach(w => {
                const editor = w.querySelector('.editor-content');
                const iframe = w.querySelector('iframe');
                const container = w.querySelector('.editor-container');
                widgets.push({ 
                    type: w.dataset.type, 
                    top: w.style.top, 
                    left: w.style.left, 
                    width: container ? container.style.width : null,
                    height: container ? container.style.height : null,
                    content: editor ? editor.innerHTML : (iframe ? iframe.src : null),
                    isTransparent: w.getAttribute('data-transparent') === 'true',
                    bgColor: w.style.backgroundColor
                });
            });
            localStorage.setItem('bureauProfData', JSON.stringify(widgets));
        }
        function restoreWidget(wData) {
            const w = createWidget(wData.type, false);
            w.style.top = wData.top; 
            w.style.left = wData.left;
            const container = w.querySelector('.editor-container');
            if (container && wData.width) container.style.width = wData.width;
            if (container && wData.height) container.style.height = wData.height;
            if (wData.content) {
                const editor = w.querySelector('.editor-content');
                const iframe = w.querySelector('iframe');
                if (editor) editor.innerHTML = wData.content;
                if (iframe) { iframe.src = wData.content; if(w.querySelector('input')) w.querySelector('input').value = wData.content; }
            }
            if (wData.bgColor && wData.bgColor !== 'transparent') {
                w.style.backgroundColor = wData.bgColor;
                if(container) container.style.background = wData.bgColor;
                const content = w.querySelector('.editor-content');
                if(content) content.style.background = wData.bgColor;
            }
            if (wData.isTransparent) {
                w.setAttribute('data-transparent', 'true');
                w.style.backgroundColor = 'transparent';
                w.style.boxShadow = 'none';
                w.style.borderColor = 'transparent';
                if(container) { container.style.background = 'transparent'; container.style.border = 'none'; }
            }
        }
        function clearBoard() { document.getElementById('modal-overlay').style.display = 'flex'; }
        function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }
        function confirmClearBoard() { takeSnapshot(); document.querySelectorAll('.widget').forEach(w => w.remove()); localStorage.removeItem('bureauProfData'); closeModal(); saveBoard(); }

        function toggleFullScreen(element) {
            if (!document.fullscreenElement) {
                if (element.requestFullscreen) element.requestFullscreen();
                else if (element.webkitRequestFullscreen) element.webkitRequestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
        window.onload = () => {
            const savedBg = localStorage.getItem('bureauProfBg');
            if (savedBg) applyBackground(savedBg);
            const data = localStorage.getItem('bureauProfData');
            if (data) { JSON.parse(data).forEach(wData => restoreWidget(wData)); } 
            else { createWidget('text', false); }
        };
    </script>
</body>
</html>